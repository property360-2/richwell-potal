{% extends 'base.html' %}

{% block title %}Enroll in Subject - Richwell Colleges Portal{% endblock %}

{% block page_header %}
<div class="page-header">
    <div class="container">
        <h1><i class="bi bi-plus-circle"></i> Enroll in Subject</h1>
        <p class="lead mb-0">Select and enroll in available subjects for {{ enrollment.semester.name }}</p>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8 mx-auto">
        <!-- Enrollment Info Card -->
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-info-circle"></i> Enrollment Information
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p class="mb-2">
                            <strong>Student:</strong> {{ student.user.get_full_name|default:student.user.username }}
                        </p>
                        <p class="mb-2">
                            <strong>Student ID:</strong> {{ student.student_id }}
                        </p>
                    </div>
                    <div class="col-md-6">
                        <p class="mb-2">
                            <strong>Semester:</strong> {{ enrollment.semester.name }}
                        </p>
                        <p class="mb-2">
                            <strong>Current Load:</strong> <span class="badge bg-info">Units info from dashboard</span>
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Enrollment Form -->
        <div class="card">
            <div class="card-header">
                <i class="bi bi-form-check"></i> Select Subject to Enroll
            </div>
            <div class="card-body">
                {% if form.non_field_errors %}
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        <strong>Errors:</strong>
                        <ul class="mb-0">
                            {% for error in form.non_field_errors %}
                                <li>{{ error }}</li>
                            {% endfor %}
                        </ul>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endif %}

                <form method="post" novalidate>
                    {% csrf_token %}

                    <!-- Subject Selection -->
                    <div class="mb-4">
                        <fieldset>
                            <legend class="form-label">{{ form.subject.label }}</legend>
                            <div class="text-muted small mb-2">Select the subject you want to enroll in</div>

                            {% if form.subject.errors %}
                                <div class="alert alert-danger py-2 px-3" role="alert">
                                    {{ form.subject.errors }}
                                </div>
                            {% endif %}

                            <div style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; padding: 1rem;">
                                {% for radio in form.subject %}
                                    <div class="form-check mb-3">
                                        {{ radio.tag }}
                                        <label class="form-check-label" for="{{ radio.id_for_label }}">
                                            <strong>{{ radio.choice_label }}</strong>
                                        </label>
                                    </div>
                                {% empty %}
                                    <p class="text-muted mb-0">No subjects available for enrollment.</p>
                                {% endfor %}
                            </div>
                        </fieldset>
                    </div>

                    <!-- Section Selection (Optional) -->
                    <div class="mb-4">
                        <fieldset>
                            <legend class="form-label">{{ form.section.label }}</legend>
                            <div class="text-muted small mb-2">Leave blank to let the system auto-assign a section</div>

                            {% if form.section.errors %}
                                <div class="alert alert-danger py-2 px-3" role="alert">
                                    {{ form.section.errors }}
                                </div>
                            {% endif %}

                            <div style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; padding: 1rem;">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="radio" name="section" id="id_section_auto" value="">
                                    <label class="form-check-label" for="id_section_auto">
                                        <em>Auto-assign section</em>
                                    </label>
                                </div>
                                {% for radio in form.section %}
                                    <div class="form-check mb-2">
                                        {{ radio.tag }}
                                        <label class="form-check-label" for="{{ radio.id_for_label }}">
                                            {{ radio.choice_label }}
                                        </label>
                                    </div>
                                {% endfor %}
                            </div>
                        </fieldset>
                    </div>

                    <!-- Schedule Conflict Override -->
                    <div class="mb-4 p-3 bg-light border-left-4" style="border-left: 4px solid var(--purple);">
                        <div class="form-check mb-2">
                            {{ form.override_schedule_conflict }}
                            <label class="form-check-label" for="{{ form.override_schedule_conflict.id_for_label }}">
                                <strong>{{ form.override_schedule_conflict.label }}</strong>
                                <small class="d-block text-muted mt-1">Only available to registrars</small>
                            </label>
                        </div>

                        {% if form.override_schedule_conflict.errors %}
                            <div class="alert alert-danger py-2 px-3 mt-2" role="alert">
                                {{ form.override_schedule_conflict.errors }}
                            </div>
                        {% endif %}

                        <!-- Override Reason (shown when override is checked) -->
                        <div id="override_reason_section" style="display: none;" class="mt-3">
                            <div class="mb-3">
                                <label for="{{ form.override_reason.id_for_label }}" class="form-label">
                                    {{ form.override_reason.label }}
                                </label>
                                {{ form.override_reason }}
                                {% if form.override_reason.errors %}
                                    <div class="invalid-feedback" style="display: block;">
                                        {{ form.override_reason.errors }}
                                    </div>
                                {% endif %}
                                <small class="form-text text-muted d-block mt-1">
                                    Provide a reason for overriding the schedule conflict
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- Form Actions -->
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="bi bi-check-circle"></i> Enroll
                        </button>
                        <a href="{% url 'sis:student_dashboard' %}" class="btn btn-outline-secondary btn-lg">
                            <i class="bi bi-x-circle"></i> Cancel
                        </a>
                    </div>
                </form>
            </div>
        </div>

        <!-- Information Card -->
        <div class="card mt-4">
            <div class="card-header">
                <i class="bi bi-question-circle"></i> Enrollment Guidelines
            </div>
            <div class="card-body">
                <ul class="mb-0 ps-3">
                    <li class="mb-2">You can enroll in a maximum of 30 units per semester</li>
                    <li class="mb-2">Prerequisite subjects must be completed before enrolling in dependent courses</li>
                    <li class="mb-2">Course selections are subject to approval and section availability</li>
                    <li>Contact the registrar if you need to override schedule conflicts</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
    // Show/hide override reason field based on checkbox
    document.addEventListener('DOMContentLoaded', function() {
        const overrideCheckbox = document.getElementById('{{ form.override_schedule_conflict.id_for_label }}');
        const overrideReasonSection = document.getElementById('override_reason_section');

        function toggleOverrideReason() {
            if (overrideCheckbox.checked) {
                overrideReasonSection.style.display = 'block';
            } else {
                overrideReasonSection.style.display = 'none';
            }
        }

        overrideCheckbox.addEventListener('change', toggleOverrideReason);
        toggleOverrideReason(); // Initialize on page load
    });
</script>

<style>
    .form-check-input {
        margin-top: 0.35rem;
    }

    textarea.form-control {
        resize: vertical;
        font-size: 0.95rem;
    }
</style>
{% endblock %}
